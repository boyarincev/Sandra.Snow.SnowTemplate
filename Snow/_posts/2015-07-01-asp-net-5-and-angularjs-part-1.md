---
layout: post
title: ASP.NET 5 и AngularJS Часть 1, Настраиваем проект: Grunt
categories: ASP-NET-5
published: draft
---

Это первая часть в серии постов по построению приложения на ASP.NET 5 (ASP.NET vNext) с использованием AngularJS. В этой серии, я по шагам буду создавать реальное приложение помогающее формировать привычки, используя ASP.NET 5, Entity Framework 7 и AngularJS. Мы разберемся с новыми возможностями, которые предоставляет ASP.NET 5 и научимся работать с современными инструментами фронт-енд разработчика. Можно рассматривать эту серию постов, как небольшой курс для начинающих ASP.NET разработчиков или уже опытных ASP.NET разработчиков, которые хотели бы изучить современный веб-стек. Я постараюсь дать минимально необходимый набор информации по всем затронутым вопросам и обеспечить вас ссылками глубже раскрывающие эти вопросы, так чтобы после окончания чтения вы могли продолжить создавать веб-приложения самостоятельно. Если вы хотите получить максимальную пользу - то придумайте идею для своего веб-приложения и создавайте его параллельно с чтением, так вы запомните максимум информации и плюс получите реальное веб-приложение в свое портфолио.

При выборе идеи своего веб-приложения, обратите внимание, что под веб-приложением я понимаю не просто веб-сайт с набором страниц и какой-либо информацией, а нечто с чем пользователь взаимодействует интерактивно, думайте о нем, как о десктопном приложении, просто реализованном в виде веб-сайта.

Вы можете скачать код обсуждаемый в этом посте из GitHub:

[https://github.com/boyarincev/GetHabitsAspNet5](https://github.com/boyarincev/GetHabitsAspNet5)

В этом посте я опишу как подготовить Asp .Net 5 проект к разработке, в частности, как настроить Grunt на минификацию и объединение javascript файлов автоматически.

<!--excerpt-->

##Содаем Asp .Net 5 проект##

Мы будем использовать [Visual Studio 2015 Community Edition](https://www.visualstudio.com/downloads/download-visual-studio-vs) - она бесплатна для личного использования.

После ее установки и запуска, выберите File, New, Project, а затем в разделе Templates, Visual C#, Web выберите ASP.NET Web Application и назовите новый проект "GetHabitsAspNet5".

![Создаем новый Asp.NET 5 проект](/images/asp-net-5/part1/create-new-project.jpg)

Далее выберите, Empty шаблон в разделе ASP.NET 5 Preview Templates.

![Выбираем Empty Template](/images/asp-net-5/part1/choose-empty-template.jpg)

После того, как студия закончит генерацию шаблона, вы получите пустой ASP.NET 5 проект.

![Empty шаблон в Solution Explorer](/images/asp-net-5/part1/empty-project-sol-explorer.jpg)

Шаблон ASP.NET 5 значительно отличается от предыдущих версий. Теперь солюшен разделен на две папки, первая "Solution Items", вторая "src". Папка src содержит сам проект GetHabitsAspNet5.

GetHabitsAspNet5 проект содержит новую папку wwwroot. Назначение этой папки - хранить весь статический контент сайта: html, javascript, css файлы, картинки и другие ресурсы. Думайте о этой папке, как о корне вашего веб-сайта. Доступ к контенту за пределами этой папки теперь запрещен и вам не нужно беспокоиться, что какие-то файлы из корня проекта, могут быть доступны пользователям. Ну и соотвественно не следует хранить в ней файлы с исходным кодом, Less файлы, файлы javascript, которые еще планируется объединять и минифицировать - любые не подготовленные к использованию ресурсы. 

Давайте в корне проекта GetHabitsAspNet5 создадим папку Scripts - в ней мы будем хранить все javascript файлы.

![Создаем папку Scripts](/images/asp-net-5/part1/script-folder.jpg)

Вероятно раньше, для объединения и минификации javascript вы использовали механизм бандлов из ASP.NET MVC или функции расширения WebEssentials, но теперь, с нативной поддержкой Grunt, мы можем всю подготовку фронт-енда делать с помощью него.

##Используем NPM для получения необходимых пакетов##

Visual Studio 2015 нативно поддерживает три пакетных менеджера: NuGet, NPM и Bower.

Пакетные менеджеры позволяют легко устанавливать в ваш проект нужные вам ресурсы.

Предыдущие версии Visual Studio поддерживали только NuGet и он использовался как для установки бэк-енд пакетов (различные .Net библиотеки), так и для фронт-енд (JQuery, Boostrap и т.д.). Теперь NuGet будет использоваться только для .Net библиотек. Вы указываете какие NuGet пакеты вам нужны в проекте в файле project.json - этот файл, также содержит настройки проекта и заменяет файл web.config.

ASP.NET 5 также поддерживает NPM пакеты. NPM - пакетный менеджер созданный для управления пакетами NodeJS (альтернативный ASP.NET фреймворк для создания веб-приложений). Для управления пакетами NPM используется файл package.json.

И наконец, ASP.NET 5 поддерживает пакетный менеджер Bower. Bower - это пакетный менеджер созданный Twitter, для поддержки фронт-енд разработки, вы можете использовать его для управления клиентскими ресурсами, такими как AngularJS, JQuery, Bootstrap и т.д.

Для подготовки ресурсов к публикации на веб-сервер мы будем использовать [Grunt](http://gruntjs.com/). Grunt - это менеджер задач написанный на NodeJS, он имеет множество плагинов, которые упрощают пред-продакшен подготовку фронт-енд ресурсов. Для его установки и установки плагинов для него, мы будем использовать NPM.

Следуйте следующим шагам:

1. Клик правой кнопкой мыши по заголовку проекта GetHabitsAspNet5 и выберите в контекстном меню Add, New Item.
2. Выберите NPM Configuration файл в DNX, Client-side.
3. Кликните кнопку Add.

![Файл конфигурации NPM](/images/asp-net-5/part1/npm-config-file.jpg)

Проделав эти шаги, вы добавите файл package.json в корень проекта GetHabitsAspNet5.

Вероятно он будет выглядеть вот так:

	{
		"version": "1.0.0",
		"name": "ASP.NET",
		"private": true,
		"devDependencies": {
		}
	} 

Для того, чтобы сказать NPM какие пакеты нам требуется установить, нужно добавить их в раздел devDependencies. Давайте добавим в него grunt и несколько плагинов к нему.

Исправьте ваш файл package.json, чтобы он выглядел вот так:

	{
	  "version": "1.0.0",
	  "name": "ASP.NET",
	  "private": true,
	  "devDependencies": {
	    "grunt": "~0.4.5",
	    "grunt-contrib-uglify": "~0.9.1",
	    "grunt-contrib-watch": "~0.6.1"
	  }
	}

Мы указали, что нам требуется три пакета: grunt, grunt-contrib-uglify, grunt-contrib-watch, после имени каждого пакета мы указали, версию пакета, которую хотели бы использовать. Обратите внимание, что, после того как вы наберете название пакета и поставите двоеточие, студия будет подсказывать вам, возможные варианты для выбора версии пакета.

После того, как вы сохраните изменения в package.json в папке Dependencies появится новая под директория NPM и студия начнет загрузку выбранных пакетов (физически они будут находится в папке node-modules в корне проекта - но эта папка не отображается в Solution Explorer), их можно будет увидеть, раскрыв папку NPM. Если загрузка не начнется, вы можете щелкнуть правой кнопкой мыши по ней и выбрать пункт "Restore Packages".

![Установленные NPM пакеты](/images/asp-net-5/part1/npm-packages.jpg)

##Зачем нужен Bower?##

Вы можете использовать Bower, как я упоминал ранее, для управления всеми пакетами, для фронт-енд разработки. Например, вы можете использовать Bower для установки в ваш проект AngularJS.

Но на данный моменр мы не будем использовать Bower для установки AngularJS, вместо этого мы используем Google CDN, просто добавив ссылку на него:

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>

Преимущество использование общедоступных CDN заключается в том, что позволяет браузеру пользователя не загружать одни и те же библиотеки при каждом посещении нового сайта, а загрузить их один раз, а затем просто доставать их из кэша, так как они находятся по одному и тому же адресу (естественно, это относится к популярным библиотекам и популярным CDN, так как так будет больше вероятность, что кто-то еще использует их на каком-то другом сайте).

##Настроим Grunt для подготовки Javascript файлов##

Grunt отлично подходит для подготовки любых фронт-енд ресурсов: компиляции Less и Saas файлов в CSS, сжатия изображений, склеивания и минификации Javascript файлов и т.д.

В этот посте мы настроим Grunt для автоматического склеивания и минификации Javascript файлов из Script директории в один итоговый файл app.js в папке wwwroot.

Следуйте следующим шагам:

1. Клик правой кнопкой мыши по проекту GetHabitsAspNet5 и выберите Add, New Item.
2. В DNX, Client-side выберите Grunt Configuration file.
3. Нажмите кнопку Add.

![Grunt Configuration file](/images/asp-net-5/part1/grunt-config-file.jpg)

После завершения этих шагов в проекте появится новый файл с именем Gruntfile.js.

Модифицируйте контент этого файла, чтобы он выглядел вот так:

	module.exports = function (grunt) {
	    //загружаем плагины Grunt
	    grunt.loadNpmTasks('grunt-contrib-uglify');
	    grunt.loadNpmTasks('grunt-contrib-watch');
	
	    //настраиваем плагины
	    grunt.initConfig({
	        uglify: {
	            scripts: {
	                files: { 'wwwroot/app.js': ['Scripts/app.js', 'Scripts/**/*.js'] }
	            }
	        },
	        watch: {
	            scripts: {
	                files: ['Scripts/**/*.js'],
	                tasks: ['uglify']
	            }
	        }
	    });
	
	    //настроим запуск задач
	    grunt.registerTask('default', ['uglify', 'watch']);
	};

Давайте разберемся, что мы только что сделали.

Наш Gruntfile.js содержит три секции. Первая секция, указывает какие NPM плагины Grunt мы будем использовать. Мы указываем два плагина: 'grunt-contrib-uglify' и 'grunt-contrib-watch'. Плагины, в контексте Grunt, являются Задачами - так как они производят некоторые действия, после того как Grunt из запускает.

Вторая секция производит настройку загруженных задач. 

Uglify задача настроена так, что она будет склеивать и минифицировать все javascript файлы из директории Scripts и результирующий файл с названием app.js размещать в директории wwwroot.

	uglify: {
	    scripts: {
	        files: { 'wwwroot/app.js': ['Scripts/app.js', 'Scripts/**/*.js'] }
	    }
	}

`uglify` - название настраиваемой задачи, как правило оно совпадает с названием npm пакета (`grunt` в названии пакета `grunt-contrib-uglify` - это указание, что это плагин для Grunt, а `contrib` - то что пакет создан Grunt Team), но вы всегда можете уточнить эту информацию на странице пакета. Вот, например страница пакета Uglify: [https://www.npmjs.com/package/grunt-contrib-uglify](https://www.npmjs.com/package/grunt-contrib-uglify).

`scripts` - имя блока настроек для задачи, в контексте Grunt он называется Target - это может быть произвольное имя и при конфигурировании задачи мы можем указать несколько разных Target, я выбрал имя `scripts`, потому что с помощью этого target мы будем склеивать и минифицировать javascript файлы, мы можем определить еще один target, который бы склеивал css файлы и назвать его, например `css`. При запуске задачи мы также можем выбрать, для какого target мы хотели бы ее запустить.

`files` - блок, в котором мы указываем, к каким файлам будет применен target. Синтаксис, который я использовал для задания списка файлов, называется "Files Object Format", подробнее про него можно почитать здесь: [http://gruntjs.com/configuring-tasks#files-object-format](http://gruntjs.com/configuring-tasks#files-object-format) - существует несколько альтернативных способов задания списка используемых задачей файлов, прочитать о них всех можно здесь: [http://gruntjs.com/configuring-tasks#files](http://gruntjs.com/configuring-tasks#files).
В данном синтаксисе, слева мы указываем путь до файла с результатами, а справа - массив исходных файлов.

Для указания исходных файлов я использовал массив, в котором явно указал `Scripts/app.js` файл, чтобы контент из него в результирующем файле был первым, так как этот файл будет объявлять главные модули AngularJS. Uglify будет объединять файлы в том порядке, в котором они указаны.

Кроме блока `files`, существует еще блок `options` - в котором мы можем указывать настройки для запуска задачи, мы пока его не использовали, так как нас устраивают настройки по-умолчанию.

Вот так могла бы выглядеть настройка Uglify с использованием блока `options`:

	grunt.initConfig({
	  uglify: {
	    options: {
	      mangle: false
	    },
	    my_target: {
	      files: {
	        'dest/output.min.js': ['src/input.js']
	      }
	    }
	  }
	});

В данном случае `options` определяет настройки для всех target задачи, но он может и задаваться индивидуально, для каждого target:

	grunt.initConfig({
	  uglify: {
	    my_target: {
		  options: {
		    mangle: false
		  },
	      files: {
	        'dest/output.min.js': ['src/input.js']
	      }
	    }
	  }
	});

Блоки target, file, options - стандартные и как правило используются всеми задачами Grunt, так что умение их использовать - важная часть использования Grunt. 

Watch задача настроена так, что она отслеживает любые изменения в Javascript файлах в директории Scripts и при их изменении запускает Uglify:

    watch: {
        scripts: {
            files: ['Scripts/**/*.js'],
            tasks: ['uglify']
        }
    }

Последняя секции, объявляет наши собственные задачи - мы объявляем задачу 'default', которая будет последовательно запускать сначала 'uglify' - для минификации и склейки файлов, а затем 'watch' плагин - для отслеживания изменений в файлах.

Кстати, для задания маски, по которой мы фильтруем javascript файлы (`Scripts/**/*.js`), мы использовали, так называемый [Globbing pattern](http://gruntjs.com/configuring-tasks#globbing-patterns).

`**` в нем задают любую вложенность директорий с любыми файлами, а `*` - любые символы в любом количестве, в названии файла.

Теперь давайте запустим настроенные задачи:

1. Выберите Меню View, Other Windows, Task Runner Explorer.
2. Для того, чтобы студия нашла, какие задачи есть в вашем проекте кликните кнопку Refresh.
3. Для запуска задачи кликните правой кнопкой мыши по задаче `default` и нажмите Run.

![Запуск задачи default](/images/asp-net-5/part1/default-run.jpg)

В списке задач, вы видите все доступные вам для запуска задачи, запуск задачи `uglify` запустит ее для всех ее target, вы также можете запустить и отдельный target: Кликните правой кнопкой мыши по `uglify:scripts` и выберите Run - вы запустили задачу для target `scripts`.

Теперь давайте назначим запуск задачи `default` на событие открытия проекта:
1. Щелкните правой кнопкой мыши по задаче  `default`, пункт меню Bindings.
2. Выберите Open Project.

##Как учиться работать с Grunt?##

Если вы никогда раньше, не сталкивались с миром NodeJS и не использовали Grunt, то такое количество новой информации, по-началу может быть пугающим. Но все не так сложно, как можем показаться сначала.

Во-первых прочтите [Grunt Getting Started](http://gruntjs.com/getting-started).

Во-вторых изучите [синтаксис конфигурирования Gruntfile.js](http://gruntjs.com/configuring-tasks).

Выбрать нужные вам плагины вы можете здесь: [http://gruntjs.com/plugins](http://gruntjs.com/plugins) - каталог содержит несколько тысяч плагинов, но вы в большинстве случаев будете использовать только несколько плагинов и они наверняка будут самыми первыми в списке.

Каждый плагин может иметь свои специфичные настройки и вам нет необходимости знать их наизусть, вы просто переходите на страницу плагина и читаете как он настраивается и смотрите примеры настройки, а затем настраиваете по аналогии.

Вот, например, страницы плагинов [watch](https://www.npmjs.com/package/grunt-contrib-watch) и [uglify](https://www.npmjs.com/package/grunt-contrib-uglify).

Также пример настройки Grunt [можно прочитать](http://docs.asp.net/en/latest/client-side/using-grunt.html) в документации ASP.NET.

Ну и наконец [статья на frontender.info](http://frontender.info/a-beginners-guide-to-grunt-redux/) описывающая настройку нескольких плагинов Grunt.

##Заключение##

В этом посте мы научились настраивать Grunt для автоматической склейки и минификации javascript файлов в ASP.NET 5 проекте. В следующем мы настроим получение списка привычек от MVC 6 WebApi и их отображение с помощью AngularJS.