---
layout: post
title: ASP.NET 5 и AngularJS Часть 1, Настраиваем проект: Grunt
categories: ASP-NET-5
published: draft
---

Это первая часть в серии постов по построению приложения на ASP.NET 5 (ASP.NET vNext) с использованием AngularJS. В этой серии, я по шагам буду создавать реальное приложение помогающее формировать привычки, используя ASP.NET 5, Entity Framework 7 и AngularJS. Мы разберемся с новыми возможностями, которые предоставляет ASP.NET 5 и научимся работать с современными инструментами фронт-енд разработчика. Я рассматриваю эту серию постов, как небольшой курс для начинающих ASP.NET разработчиков или уже опытных ASP.NET разработчиков, которые хотят перейти на современный веб-стек технологий, поэтому постараюсь дать минимально необходимый набор информации по всем затронутым вопросам и обеспечить вас ссылками на ресурсы глубже раскрывающие их, так чтобы после окончания этого курса вы могли продолжить создавать веб-приложения самостоятельно. Если вы хотите получить максимальную пользу - то придумайте идею для своего веб-приложения и создавайте его параллельно с чтением этой серии, так вы запомните максимум информации и плюс получите реальное веб-приложение в портфолио.

Обратите внимание, что под веб-приложением я понимаю, не просто веб-сайт с набором страниц и какой-либо информацией, а нечто с чем пользователь взаимодействует интерактивно, если ваше приложение можно реализовать, как обычное приложение, то оно с большой долей вероятности подойдет.

Вы можете скачать код обсуждаемый в этой статье из GitHub:

[https://github.com/boyarincev/GetHabitsAspNet5](https://github.com/boyarincev/GetHabitsAspNet5)

В этом посте я опишу как подготовить Asp .Net 5 проект к разработке, в частности, как настроить Grunt на минификацию и объединение javascript файлов автоматически.

##Содаем Asp .Net 5 проект##

Мы будем использовать [Visual Studio 2015 Community Edition](https://www.visualstudio.com/downloads/download-visual-studio-vs) - она бесплатна для личного использования.

После ее установки и запуска, выберите File, New, Project, а затем в разделе Templates, Visual C#, Web выберите ASP.NET Web Application и назовите новый проект "GetHabitsAspNet5".

![Создаем новый Asp.NET 5 проект](/images/asp-net-5/part1/create-new-project.jpg)

Далее выберите, Empty шаблон в разделе ASP.NET 5 Preview Templates.

![Выбираем Empty Template](/images/asp-net-5/part1/choose-empty-template.jpg)

После того, как студия закончит генерацию шаблона, вы получите пустой ASP.NET 5 проект.

![Empty шаблон в Solution Explorer](/images/asp-net-5/part1/empty-project-sol-explorer.jpg)

Шаблон ASP.NET 5 значительно отличается от предыдущих версий. Теперь солюшен разделен на две папки, первая "Solution Items", вторая "src". Папка src содержит сам проект GetHabitsAspNet5.

GetHabitsAspNet5 проект содержит новую папку wwwroot. Назначение этой папки - хранить весь статический контент сайта: html, javascript, css файлы, картинки и другие ресурсы. Доступ к статическому контенту за пределами этой папки теперь запрещен. Не следует хранить в ней файлы с исходным кодом, Less файлы, файлы javascript, которые еще планируется объединять и минифицировать. 

Давайте в корне проекта GetHabitsAspNet5 создадим папку Scripts - в ней мы будем хранить все javascript файлы.

![Создаем папку Scripts](/images/asp-net-5/part1/script-folder.jpg)

Вероятно раньше, для объединения и минификации javascript вы использовали механизм бандлов из ASP.NET MVC или функции расширения WebEssentials, но теперь, с нативной поддержкой Grunt, мы можем всю подготовку фронт-енда делать с помощью него.

##Используем NPM для получения необходимых пакетов##

Visual Studio 2015 нативно поддерживает три пакетных менеджера: NuGet, NPM и Bower.

Пакетные менеджеры позволяют легко устанавливать в ваш проект нужные вам ресурсы.

Предыдущие версии Visual Studio поддерживали только NuGet и он использовался как для установки бэкенд пакетов (различные .Net библиотеки), так и для фронт-енда (JQuery, Boostrap и т.д.). Теперь NuGet будет использоваться только для .Net библиотек. Вы указываете какие NuGet пакеты вам нужны в проекте в файле project.json - этот файл, также содержит настройки проекта и заменяет файл web.config.

ASP.NET 5 также поддерживает NPM пакеты. NPM - пакетный менеджер созданный для управления пакетами NodeJS (альтернативный ASP.NET фреймворк для создания веб-приложений). Для управления пакетами NPM используется файл package.json.

И наконец, ASP.NET 5 поддерживает пакетный менеджер Bower. Bower - это пакетный менеджер созданный Twitter, для поддержки фронт-енд разработки, вы можете использовать его для управления клиентскими ресурсами, такими как AngularJS, JQuery, Bootstrap и т.д.

Для подготовки ресурсов к публикации на веб-сервер мы будем использовать [Grunt](http://gruntjs.com/). Grunt - это менеджер задач написанный на NodeJS, он имеет множество плагинов, которые упрощают пред-продакшен подготовку фронт-енд ресурсов. Для его установки и установки плагинов для него, мы будем использовать NPM.

Следуйте следующим шагам:

1. Клик правой кнопкой мыши по заголовку проекта GetHabitsAspNet5 и выберите в контекстном меню Add, New Item.
2. Выберите NPM Configuration файл в DNX, Client-side.
3. Кликните кнопку Add.

![Файл конфигурации NPM](/images/asp-net-5/part1/npm-config-file.jpg)

Проделав эти шаги, вы добавите файл package.json в корень проекта GetHabitsAspNet5.

Вероятно он будет выглядеть вот так:

	{
		"version": "1.0.0",
		"name": "ASP.NET",
		"private": true,
		"devDependencies": {
		}
	} 

Для того, чтобы сказать NPM какие пакеты нам требуется установить, нужно добавить их в раздел devDependencies. Давайте добавим в него grunt и несколько плагинов к нему.

Исправьте ваш файл package.json, чтобы он выглядел вот так:

	{
	  "version": "1.0.0",
	  "name": "ASP.NET",
	  "private": true,
	  "devDependencies": {
	    "grunt": "~0.4.5",
	    "grunt-contrib-uglify": "~0.9.1",
	    "grunt-contrib-watch": "~0.6.1"
	  }
	}

Мы указали, что нам требуется три пакета: grunt, grunt-contrib-uglify, grunt-contrib-watch, после имени каждого пакета мы указали, версию пакета, которую хотели бы использовать. Обратите внимание, что, после того как вы наберете название пакета и поставите двоеточие, студия будет подсказывать вам, возможные варианты для выбора версии пакета.

После того, как вы сохраните изменения в package.json в папке Dependencies появится новая под директория NPM и студия начнет загрузку выбранных пакетов (физически они будут находится в папке node-modules в корне проекта - но эта папка не отображается в Solution Explorer), их можно будет увидеть, раскрыв папку NPM. Если загрузка не начнется, вы можете щелкнуть правой кнопкой мыши по ней и выбрать пункт "Restore Packages".

![Установленные NPM пакеты](/images/asp-net-5/part1/npm-packages.jpg)

##Зачем нужен Bower?##

Вы можете использовать Bower, как я упоминал ранее, для управления всеми пакетами, для фронт-енд разработки. Например, вы можете использовать Bower для установки в ваш проект AngularJS.

Но мы не будем использовать Bower для установки AngularJS в этот проект, вместо этого мы используем Google CDN, просто добавив ссылку на него:

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>

Использование общедоступных CDN позволяет браузеру пользователя не загружать библиотеки при каждом посещении нового сайта, а загрузить их один раз, а затем просто доставать их из кэша (естественно, это относится к популярным библиотекам и популярным CDN, так как так будет больше вероятность, что кто-то еще использует их на другом сайте).

##Настроим Grunt для подготовки Javascript файлов##

Grunt отлично подходит для подготовки любых фронт-енд ресурсов: компиляции Less и Saas файлов в CSS, сжатия изображений, склеивания и минификации Javascript файлов и т.д.

В этот посте мы настроим Grunt для автоматического склеивания и минификации Javascript файлов из Script директории в один итоговый файл app.js в папке wwwroot.

Следуйте следующим шагам:

1. Клик правой кнопкой мыши по проекту GetHabitsAspNet5 и выберите Add, New Item.
2. В DNX, Client-side выберите Grunt Configuration file.
3. Нажмите кнопку Add.

![Grunt Configuration file](/images/asp-net-5/part1/grunt-config-file.jpg)

После завершения этих шагов в проекте появится новый файл с именем Gruntfile.js.

Модифицируйте контент этого файла, чтобы он выглядел вот так:

	module.exports = function (grunt) {
	    //загружаем плагины Grunt
	    grunt.loadNpmTasks('grunt-contrib-uglify');
	    grunt.loadNpmTasks('grunt-contrib-watch');
	
	    //настраиваем плагины
	    grunt.initConfig({
	        uglify: {
	            scripts: {
	                files: { 'wwwroot/app.js': ['Scripts/app.js', 'Scripts/**/*.js'] }
	            }
	        },
	        watch: {
	            scripts: {
	                files: ['Scripts/**/*.js'],
	                tasks: ['uglify']
	            }
	        }
	    });
	
	    //настроим запуск задач
	    grunt.registerTask('default', ['uglify', 'watch']);
	};

Наш Gruntfile.js содержит три секции. Первая секция, указывает какие NPM плагины Grunt мы будем использовать. Мы указываем два плагина: 'grunt-contrib-uglify' и 'grunt-contrib-watch'.

Вторая секция производит настройку загруженных плагинов. Uglify плагин настроен так, что он будет склеивать и минифицировать все javascript файлы из директории Scripts и результирующий файл с названием app.js размещать в директории wwwroot.

	uglify: {
	    scripts: {
	        files: { 'wwwroot/app.js': ['Scripts/app.js', 'Scripts/**/*.js'] }
	    }
	}

Для указания исходных файлов я использовал массив, в котором явно указал Scripts/app.js файл, чтобы контент из него в результирующем файле был первым, так как файл он будет объявлять главные модули AngularJS. Uglify будет объединять файлы в том порядке, в котором они указаны.

Синтаксис для задания списка файлов, который мы использовали, называется Files Object Format, подробнее про него можно почитать здесь: [http://gruntjs.com/configuring-tasks#files-object-format](http://gruntjs.com/configuring-tasks#files-object-format) - существует несколько альтернативных способов задания списка используемых плагинов файлов, подробнее о них всех можно прочитать здесь: [http://gruntjs.com/configuring-tasks](http://gruntjs.com/configuring-tasks)

Watch плагин настроен так, что он отслеживает любые изменения в Javascript файлах в директории Scripts и при их изменении запускает Uglify:

    watch: {
        scripts: {
            files: ['Scripts/**/*.js'],
            tasks: ['uglify']
        }
    }

Последняя секции, объявляет наши собственные задачи - мы объявляем задачу 'default', которая будет последовательно запускать сначала 'uglify' - для минификации и склейки файлов, а затем 'watch' плагин - для отслеживания изменений в файлах.

Кстати, для задания маски, по которой мы фильтруем javascript файлы, мы использовали, так называемый [Globbing pattern](http://gruntjs.com/configuring-tasks#globbing-patterns).

`**` в нем задают любую вложенность директорий с любыми файлами, а `*` - любые символы в любом количестве, в названии файла.

##Изучение Grunt##

Если вы никогда раньше, не сталкивались с миром NodeJS и не использовали Grunt, то такое количество новой информации, по-началу может быть пугающим - еще бы, вы только что открыли для себя целый новый мир, который до сих пор скрывался от ваших глаз, так как ASP.NET разработчики в большинстве случаев жили в своей закрытой экосистеме Microsoft. Но вам не нужно бояться, вполне реально усвоить эту информацию и уверенно использовать, все эти новые возможности!

Во-первых прочтите [Grunt Getting Started](http://gruntjs.com/getting-started).

Во-вторых изучите [синтаксис конфигурирования Gruntfile.js](http://gruntjs.com/configuring-tasks).

Выбрать нужные вам плагины вы можете здесь: [http://gruntjs.com/plugins](http://gruntjs.com/plugins) - каталог содержит несколько тысяч плагинов, но вы в большинстве случаев будете использовать только несколько плагинов и они наверняка будут самыми первыми в списке.

Каждый плагин может иметь свои специфичные настройки и вам нет необходимости знать их наизусть, вы просто переходите на страницу плагина и читаете как он настраивается и смотрите примеры настройки, а затем настраиваете по аналогии.

Вот, например, страницы плагинов [watch](https://www.npmjs.com/package/grunt-contrib-watch) и [uglify](https://www.npmjs.com/package/grunt-contrib-uglify).

Также пример настройки Grunt [можно прочитать](http://docs.asp.net/en/latest/client-side/using-grunt.html) в документации ASP.NET.

Ну и наконец [статья на frontender.info](http://frontender.info/a-beginners-guide-to-grunt-redux/) описывающая настройку нескольких плагинов Grunt.