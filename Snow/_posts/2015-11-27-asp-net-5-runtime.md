---
layout: post
title: Погружение в ASP.NET 5 Runtime
categories: ASP-NET-5, DNX
published: draft
---

## .NET Runtime Environment (DNX) ##

ASP.NET базируется на гибком, кроссплатформенном Runtime хосте, который может хостить разные .NET CLR (.NET Core, Mono, .NET Framework). Вы можете запустить ASP.NET 5 на полном .NET Framework или можете запустить на новом .NET Core, который позволяет вам просто копировать его в существующее окружение, без изменения чего-либо еще на вашей машине. Используя .NET Core вы также можете запустить ASP.NET 5 кроссплатформенно на Linux и Mac OS.

Инфраструктура позволяющая запускать и исполнять приложения ASP.NET 5 называется .NET Runtime Environment (DNX). DNX предоставляет все что вам необходимо для разработки приложений на .NET: host process, CLR hosting logic, обнаружение managed Entry Point и т.д.

DNX базируется на том же самом .NET CLR и базовой библиотеке классов, что знают и любят существующие .NET разработчики, и в то же время он разработан с возможностью запускать приложения (на данный момент веб и консольные приложения) под операционными системами отличными от Windows.

Логически DNX имеет пять слоев функциональности. Я опишу каждый из этих слоев и их обязанности.

## Слой первый: Нативный процесс ## 

Нативный процесс - это очень тонкий слой с обязанностью найти и вызвать нативный CLR host, передав в него аргументы переданные в сам процесс. В Windows - это dnx.exe (находится в %YOUR_PROFILE%\.dnx\runtimes\%CHOOSEN_RUNTIME%); В Mac и Linux - это запускаемый bash script. [Запуск на IIS](https://docs.asp.net/en/latest/publishing/iis.html) происходит с помощью нативного HTTP-модуля: [HTTPPlatformHandler](https://azure.microsoft.com/en-us/blog/announcing-the-release-of-the-httpplatformhandler-module-for-iis-8/), который нужно установить на IIS. Использование HTTPPlatformHandler позволяет запускать веб-приложение без любых зависимостей от .NET Framework (естественно при запуске веб-приложений нацеленных на .NET Core а не на полный .NET Framework).

## Слой второй и третий: Нативный CLR host и CLR ##

Имеют три главных обязанности:

1. Запустить CLR. Способы достижения этого отличаются в зависимости от используемой версии CLR. Например, для запуска .NET Core загружается coreclr.dll, настраивается и запускается runtime и создается AppDomain, в котором будет запускаться весь managed code. Для Mono и .NET Framework, процесс отчасти различается, но результат будет тот же самый.
2. Вызвать managed Entry Point, которая является следующим слоем.
3. Когда точка входа нативного хоста возвращает управление этот процесс будет "убирать за собой" и выключать CLR - выгружать App Domain и останавливать runtime.

## Слой четвертый: Управляемая точка входа ##

Этот слой, первый слой написанный на managed code. Он ответственен за:

1. Загрузку сборок и удовлетворение зависимостей из папки lib.
2. Настройку IApplicationEnvironment и ядра инфраструктуры системы Dependency Injection.
3. Вызов main entry point конкретного приложения.

В этом слое сборки загружаются только из каталога приложения или указанной lib папки. Есть следующий слой, что добавляет дополнительные загрузчики для разрешения зависимостей из NuGet пакетов или даже код скомпилированный во время выполнения.